<ons-page>
    <ons-toolbar class="toolbar" style="background-color: white;position: fixed;">
        <div class="left" style="padding-left: 3%;">
            <ons-back-button></ons-back-button>
        </div>
        <div class="center" style="color:#898989;">
            注文確認
        </div>
    </ons-toolbar>
    <div class="container contents" style="background-color:#efeff4;padding-bottom:30px;">
        <!-- カードリスト部分 -->
        <input type="hidden" id="check_gift_title">
        <input type="hidden" id="check_price">
        <input type="hidden" id="check_gift_uid">
        <div class="" style="width:100%;height: auto; padding: 1px 0 0 0;display: inline-block;">
            <!-- <div style="height:99%;margin:0 auto;padding:0px;width:90%;margin-top:15px;">
                <div>
                    <span style="font-size: 70%;">
                        下の「注文を確定する」ボタンを押して、ご注文いただくことで、お客様は
                        <a href="">利用規約</a> 
                        および
                        <a href="">プライバシーポリシー</a>
                        に同意の上、商品をご注文されたことになります。
                    </span>
                </div>
                <div style="width:100%;text-align:center;margin-top:5px;">
                    <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;" onclick="orderEnd();document.getElementById('navi').pushPage('orderend.html')">注文を確定する</button>
                </div>
            </div> -->
            <div style="height:99%;margin:0 auto;padding:0px;width:90%;margin-top:20px;">
                <div>
                    <span>注文詳細</span>
                </div>
                <div class="card" style="width: 100%; margin: 0 auto;margin-top:3px;background-color: white;border:1px solid #898989;border-radius: 20px">
                    <ul class="list">
                        <li class="list-item">
                            <div class="list-item__center" style="font-size: 80%;">
                                <div style="width:100%;">届け先</div>
                                <div id="send_human" style="width:100%;color:#898989;margin-left:10px;margin-top:5px;"></div>
                            </div>
                        </li>
                        <li class="list-item">
                            <div class="list-item__center" style="font-size: 80%;">
                            <div style="width:100%;">送り先のニックネーム</div>
                            <div id="nickname" style="width:100%;color:#898989;margin-left:10px;margin-top:5px;"></div>
                            </div>
                        </li>
                        <!-- <li class="list-item">
                            <div class="list-item__center" style="font-size: 80%;">
                            <div style="width:100%;">支払い方法</div>
                            <div style="width:100%;color:#898989;margin-left:10px;margin-top:5px;">コンビニ/ATM支払い</div>
                            </div>
                        </li> -->
                        <li class="list-item">
                            <div class="list-item__center" style="font-size: 80%;">
                                <div style="width:100%;">リクエスト内容</div>
                                <div id="request_message" style="width:100%;color:#898989;margin-left:10px;margin-top:5px;">
                                </div>
                            </div>
                        </li>
                        <li class="list-item">
                            <div class="list-item__center" style="font-size: 80%;">
                            <div style="width:100%;">ギフト内容</div>
                            <div id="check_gift_title_div"style="width:100%;color:#898989;margin-left:10px;margin-top:5px;"></div>
                            <div id="check_price_div"style="width:100%;color:#898989;margin-left:10px;margin-top:5px;"></div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div style="margin:0 auto;width:95%;margin-top:20px;">
                    <span style="font-size: 70%;color:#FF6070;">
                        ※受信制限をされている方はお手数ですが「fanfun@fanfun2020.xsrv.jp」「fanfun-ordercheck@gonmura.info」からのメールが届くように設定してください。ご注文のやり取りで使用します。
                    </span>
                </div>
                <div style="width:100%;text-align:center;margin-top:20px;margin-bottom:10px;">
                    <!-- <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;" onclick="orderEnd();document.getElementById('navi').pushPage('orderend.html')">注文を確定する</button> -->
                    <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:35px;height:35px;border-radius:30px;font-size:16px;margin:0 auto;" onclick="stripe();">カード払い画面へ</button>
                    <!-- <a class="button money_button" onclick="">¥550</a> -->
                </div>
                <div style="width:100%;text-align:center;margin-top:20px;margin-bottom:10px;">
                    <!-- <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;" onclick="orderEnd();document.getElementById('navi').pushPage('orderend.html')">注文を確定する</button> -->
                    <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:35px;height:35px;border-radius:30px;font-size:16px;margin:0 auto;background: -moz-linear-gradient(bottom left, #00C6FB, #005BEA);background: -webkit-linear-gradient(bottom left, #00C6FB, #005BEA);background: linear-gradient(to top right, #00C6FB, #005BEA);" onclick="ginkouForm();">銀行振込画面へ</button>
                    <!-- <a class="button money_button" onclick="">¥550</a> -->
                </div>
            </div>
        </div>
    </div>
    <script>
        function stripe(){
            var currentUser = ncmb.User.getCurrentUser();
            var userName = currentUser.get("userName");
            var mailaddress = currentUser.get("mailAddress");
            var objectId = currentUser.get("objectId");
            var gift_title = $('#check_gift_title').val();
            var price = $('#check_price').val()*1.04;
            var gift_uid = $('#check_gift_uid').val();
            var send_human = $('#send_human').html();
            var nickname = $('#nickname').html();
            var request = $('#request_message').html();
            var osVer;
            osVer = "Android";
            /*
            以下の文字列でユーザーエージェントを判別します
            osVer = "iPhone";
            osVer = "Android";
            osVer = "iPod";
            osVer = "iPad";
            */
            var GiftData = ncmb.DataStore("giftData");
        
            GiftData
            .equalTo("giftUid", gift_uid)
            .fetch()               
            .then(function(results){
                    var object = results;
                    var influencerId = object.get("userId");
                    var defaultPrice = object.get("price");
                    var stock = object.get("stock");
                    if(stock <= 0 || stock == '' || stock==undefined){
                        alert("申し訳ございません。在庫が0になりました。");
                        window.location.href = 'home.html';
                    }
                    ncmb.User
                        .equalTo('objectId',influencerId)
                        .fetch()
                        .then(function(results){
                            var object = results;
                            var influencerMail = object.get("mailAddress");
                            if(navigator.userAgent.indexOf(osVer)>0){
                                console.log("android");
                                androidWindow('https://fanfun2020.xsrv.jp/paybuttonNewest.html?objectId='+objectId+'&giftUid='+gift_uid+'&price='+price+'&userName='+userName+'&giftTitle='+gift_title+'&mailaddress='+mailaddress+'&sendHuman='+send_human+'&nickName='+nickname+'&request='+request+'&influencerId='+influencerId+'&defaultPrice='+defaultPrice+'&influencerMail='+influencerMail);/*特定の端末だった時に呼ばれる関数*/
                            }else{
                                console.log("androidじゃない");
                                androidWindow('https://fanfun2020.xsrv.jp/paybuttonNewest.html?objectId='+objectId+'&giftUid='+gift_uid+'&price='+price+'&userName='+userName+'&giftTitle='+gift_title+'&mailaddress='+mailaddress+'&sendHuman='+send_human+'&nickName='+nickname+'&request='+request+'&influencerId='+influencerId+'&defaultPrice='+defaultPrice+'&influencerMail='+influencerMail);
                            }
                        })
                        .catch(function(err){
                            alert("エラーが発生しました。もう一度やり直してください。");
                        });
                    
            })
            .catch(function(err){
                    console.log(err);
                    alert("エラーが発生しました。もう一度やり直してください。");
            });
            
        }
    
        function ginkouForm(){
            document.getElementById('navi').pushPage('ginkouForm.html');
            var currentUser = ncmb.User.getCurrentUser();
            var userName = currentUser.get("userName");
            var mailaddress = currentUser.get("mailAddress");
            var objectId = currentUser.get("objectId");
            var gift_title = $('#check_gift_title').val();
            var price = $('#check_price').val();
            var gift_uid = $('#check_gift_uid').val();
            var send_human = $('#send_human').html();
            var nickname = $('#nickname').html();
            var request = $('#request_message').html();
            var GiftData = ncmb.DataStore("giftData");
            GiftData
            .equalTo("giftUid", gift_uid)
            .fetch()               
            .then(function(results){
                    var object = results;
                    var influencerId = object.get("userId");
                    var defaultPrice = object.get("price");
                    var stock = object.get("stock");
                    if(stock <= 0 || stock == '' || stock==undefined){
                        alert("申し訳ございません。在庫が0になりました。");
                        window.location.href = 'home.html';
                    }
                    ncmb.User
                        .equalTo('objectId',influencerId)
                        .fetch()
                        .then(function(results){
                            var object = results;
                            var influencerMail = object.get("mailAddress");
                            setTimeout(function(){
                                $('#userNameGinkou').val(userName);
                                $('#mailaddressGinkou').val(mailaddress);
                                $('#objectIdGinkou').val(objectId);
                                $('#gift_titleGinkou').val(gift_title);
                                $('#priceGinkou').val(price);
                                $('#gift_uidGinkou').val(gift_uid);
                                $('#send_humanGinkou').val(send_human);
                                $('#nicknameGinkou').val(nickname);
                                $('#requestGinkou').val(request);
                                $('#influencerIdGinkou').val(influencerId);
                                $('#defaultPriceGinkou').val(defaultPrice);
                                $('#influencerMailGinkou').val(influencerMail);
                            },500);
                        })
                        .catch(function(err){
                            alert("エラーが発生しました。もう一度やり直してください。");
                        });
                    
            })
            .catch(function(err){
                    console.log(err);
                    alert("エラーが発生しました。もう一度やり直してください。");
            });
        }

    </script>
</ons-page>