<ons-page>
    <ons-toolbar class="toolbar" style="background-color: white;">
        <div class="left" style="padding-left: 5%;">
            <button class="button" style="border-radius:30px;background: transparent;height:80%;line-height: initial;vertical-align: middle;font-size:12px;" onclick="userReflesh();"><i class="fas fa-redo-alt fa-lg" style="color:#FF6070;"></i></button>
        </div>
        <div class="center" style="width:120%;">
            <span id="mypage_user_name" class="current_user_name" style="color:#898989;"></span> 
        </div>
        <div id=""class="right" style="padding-right: 5%;"onclick="userActionOpen();">
            <i class="fas fa-ellipsis-h"></i>
        </div>
    </ons-toolbar>
    <input type="hidden" class="current_user_id">
    <div class="contents" style="background-color: white;">
        <ul class="list list--material">
            <li class="list-item list-item--material">
                <div class="list-item__left list-item--material__left">
                    <img id="user_image" class="list-item__thumbnail list-item--material__thumbnail" src="img/human.png" alt="" style="width:70px;height:70px;object-fit: cover;">
                </div>
                <div class="list-item__center list-item--material__center">
                    <div class="list-item__subtitle list-item--material__subtitle" style="height:100%;">
                        <div style="width:49%;text-align: center;float: left;">
                            <p style="line-height: 100%;margin-bottom:5px;margin-top:10px;" onclick="document.getElementById('navi').bringPageTop('follow.html');followList();">
                                <span id="my_follow_number" style="font-weight: bold;font-size:24px;">0</span>
                                <br>
                                <span style="color:#898989;">フォロー</span>
                            </p> 
                        </div>
                        <div style="width:49%;text-align: center;float: right;border-left:1px solid #ddd;">
                            <p style="line-height: 100%;margin-bottom:5px;margin-top:10px;" onclick="document.getElementById('navi').bringPageTop('follower.html');followerList();">
                                <span id="my_follower_number" style="font-weight: bold;font-size:24px;">0</span>
                                <br>
                                <span style="color:#898989;">フォロワー</span>
                            </p> 
                        </div>
                        <div id="mypageFanRankDiv" style="width:100%;display:inline-block;padding-top:5px;font-size:1.1em;">
                            <p style="width:85%;margin:0 auto;text-align: left;border-top:1px solid #ddd;border-bottom:1px solid #ddd;padding:8px;" onclick="fanRanking('mypage');document.getElementById('navi').bringPageTop('fanRanking.html');">
                            <i class="fas fa-trophy fa-lg fa-fw" style="padding-right:5px;color:#F5ED7D;"></i>Fanランキング <span style="float: right;">></span>
                            </p>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <ul id="myPageRanking"class="list list--material" style="display:none;margin-bottom:5px;">
            <li class="list-item list-item--material">          
                <div class="list-item__left list-item--material__left" style="padding:0px;min-height: auto;">
                    <div class="list-item__subtitle list-item--material__subtitle" style="height:100%;padding:0px;">
                        <div style="width:100%;text-align: center;float: left;height:100%;">
                            <span id="myPageSougouRanking"style="line-height: 100%;margin:0px;font-size:0.8em;text-align: left;color:#FF6070;">
                            </span> 
                            <span id="myPagekyujosyoRanking"style="line-height: 100%;margin:0px;font-size:0.8em;text-align: left;color:#FF6070;">
                            </span> 
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <ul class="list list--material">
            <li class="list-item list-item--material">          
                <div class="list-item__left list-item--material__left" style="padding:0px;min-height: auto;">
                    <div class="list-item__subtitle list-item--material__subtitle" style="height:100%;padding:0px;">
                        <div style="width:100%;text-align: center;float: left;height:100%;">
                            <p class="user_name_title"style="line-height: 100%;margin:0px;font-size:18px;text-align: left;">
                            </p> 
                        </div>
                    </div>
                </div>
            </li>
            <li class="list-item">
                <div class="list-item__left" style="padding:0px;padding-left:2px;min-height: auto;padding-top:5px;">
                    <div id="myGenre"class="list-item__subtitle">
                    </div>
                </div>
            </li>
        </ul>
        <div class="other_profile_text current_text" style="max-height:100px;height:auto;font-size:14px;padding:5px 16px;">
        </div>
        <div class="" style="padding:3px 16px;text-align: right;">
            <a id="myFanfun" style="font-size:14px;margin-right:5px;color:#007aff;border-bottom:1px solid #007aff;">特設サイト</a>
            <input type="hidden" id="myFanfunURL">
            <i id="myTwitter" class="fab fa-twitter fa-lg" style="color:#1DA1F2;padding-right:5px;"></i>
            <input type="hidden" id="myTwitterURL">
            <i id="myInstagram" class="fab fa-instagram fa-lg" style="color:#CF2E92;padding-right:5px;"></i>
            <input type="hidden" id="myInstagramURL">
            <i id="myYouTube" class="fab fa-youtube fa-lg" style="color:#DA1725;"></i>
            <input type="hidden" id="myYouTubeURL">
        </div>
        <div style="margin-bottom:20px;margin-top:10px;height:20px;">
            <div style="width:49%;text-align:center;float:left;">
                <button id="exhibition_button" class="button "style="width:90%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;"onclick="document.getElementById('navi').bringPageTop('giftinput.html')" disabled>出品する</button>
            </div>
            <div style="width:49%;text-align:center;float:right;">
                <button class="button "style="width:90%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;background: -moz-linear-gradient(bottom left, #00C6FB, #005BEA);background: -webkit-linear-gradient(bottom left, #00C6FB, #005BEA);background: linear-gradient(to top right, #00C6FB, #005BEA);"onclick="document.getElementById('navi').bringPageTop('profile_edit.html');profilePage();loginImageEdit();">プロフィール編集</button>
            </div>
        </div>
        <div style="margin-bottom:25px;margin-top:25px;height:20px;">
                <div style="width:100%;text-align:center;margin:0 auto;">
                    <button id="fanRankPresentButton" class="button "style="width:95%;padding-top:0px;padding-bottom:0px;line-height:auto;border-radius:30px;font-size:16px;margin:0 auto;"onclick="document.getElementById('navi').bringPageTop('giftinput.html');fanRankPresentPageOpen();" disabled>Fanランキング上位還元プレゼント</button>
                </div>
            </div>
        <div style="width:100%;text-align:center;margin-top:20px;height:25px;">
            <p style="width:auto;line-height: 100%;margin:0px;font-size:14px;margin-top:10px;margin-bottom:10px;">
                <span id="myGiftLength" style="border-bottom:1px solid #FF6070;padding-bottom:3px;"></span>
            </p> 
        </div>
        <div id="myGiftList" style="background-color: #efeff4;">
            <!-- カードリスト部分 -->
            
        </div>
        <div id="influencerTouroku" style="background-color: #efeff4;text-align: center;padding-top:50px;padding-bottom:50px;">
            
        </div>
        <div id="kanrisyabox"style="display: none;background-color: #efeff4;width:100%;padding-top:50px;padding-bottom:400px;">
            <input type="tel" id="giftLogSearchInput" class="text-input" style="background-color: white;border:1px solid black;width:100%;margin-bottom:10px;">
            <button class="btn button" onclick="giftLogSearchInput($('#giftLogSearchInput').val());"style="margin-bottom:50px;">ギフトログ管理画面へ</button>
            <input type="tel" id="giftLogStatusChange" class="text-input" style="background-color: white;border:1px solid black;width:100%;margin-bottom:10px;">
            <button class="btn button" onclick="giftLogStatusChange($('#giftLogStatusChange').val());" style="margin-bottom:50px;">プレゼント完了</button>
            <input type="tel" id="giftLogStatusKakunin" class="text-input" style="background-color: white;border:1px solid black;width:100%;margin-bottom:10px;">
            <button class="btn button" onclick="giftLogStatusKakunin($('#giftLogStatusKakunin').val());">ギフト内容確認中</button>
            
            <br><br>
            <input type="tel" id="giftLogStatusCancel" class="text-input" style="background-color: white;border:1px solid black;width:100%;margin-bottom:10px;">
            <button class="btn button" onclick="giftLogStatusCancel($('#giftLogStatusCancel').val());" style="background:gray;">ギフトキャンセル</button>
            <br><br>
            <br><br>
            <button class="btn button" onclick="kyujosyoUserPush();">急上昇のお知らせ</button>
            <button class="btn button" onclick="sougouUserPush();">総合ランキングのお知らせ</button>
            <br><br>
        </div>
    </div>
    
    <div class="action-sheet-mask"></div>
    <div class="action-sheet modal1">
        <button id="myPageShare"class="action-sheet-button" onclick="userActionClose();setTimeout(function(){share($('.current_user_id').val(),'userPage');},1500);">SNS共有</button>
        <button class="action-sheet-button" onclick="myShitagakiGift();">下書き状態のギフト</button>
        <button class="action-sheet-button" onclick="myFavoriteGift();">Myいいねギフト一覧</button>
        <button id="myPageGuide"class="action-sheet-button" onclick="document.getElementById('navi').bringPageTop('guideList.html');">ガイド</button>
        <button class="action-sheet-button" onclick="logout();">ログアウト</button>
        <button class="action-sheet-button" onclick="userActionClose();">Cancel</button>
    </div>
    
    <div class="action-sheet-mask"></div>
    <div class="action-sheet modal2">
        <button class="action-sheet-button" onclick="tweetMyPage();">Tweet</button>
        <button class="action-sheet-button" onclick="userActionClose();">Cancel</button>
    </div>
    <!-- 以下、javascript -->
    <script type="text/javascript">
        $('.action-sheet-mask,.action-sheet').hide();

        function kyujosyoUserPush(){
            ons.notification.confirm({
            message: '急上昇ランカーに通知を飛ばしますか？',
            title: "確認",
            buttonLabels:["キャンセル","OK"],
            callback: function(buttonIndex) {
                    if(buttonIndex==1){
                        var kyujosyoData = ncmb.DataStore("kyujosyoData");
                        kyujosyoData
                        .order("rank",false)
                        .limit(15)
                        .fetchAll()         
                        .then(function(result){
                            for(var i=0;i<result.length;i++){
                                var userId = result[i].get("userId");
                                var userName = result[i].get("userName");
                                var rank = result[i].get("rank");
                                kyujosyoPush(userId,userName,rank);
                            }
                        });                        
                    }
                }
            });
        }
        function kyujosyoPush(userId,userName,rank){
            var push = new ncmb.Push();
            push.set("immediateDeliveryFlag", true)
            .set("message", "あなたは現在「急上昇ランキング"+rank+"位」にノミネートしています！")
            .set("target", ["ios", "android"])
            .set('searchCondition', {
                    userObjectId: userId,
            });
            push.send()
            .then(function(push){
                    // 送信後処理
                    alertNew(rank+"位の"+userName+"様は成功");
            })
            .catch(function(err){
                    // エラー処理
                    alertNew(rank+"位は送信NG!!!");
            });
        }
        function sougouUserPush(){
            ons.notification.confirm({
            message: '総合ランカーに通知を飛ばしますか？',
            title: "確認",
            buttonLabels:["キャンセル","OK"],
            callback: function(buttonIndex) {
                    if(buttonIndex==1){
                        var crownData = ncmb.DataStore("crownData");
                        crownData
                        .order("rank",false)
                        .limit(15)
                        .fetchAll()         
                        .then(function(result){
                            for(var i=0;i<result.length;i++){
                                var userId = result[i].get("userId");
                                var userName = result[i].get("userName");
                                var rank = result[i].get("rank");
                                sougouPush(userId,userName,rank);
                            }
                        });                        
                    }
                }
            });
        }
        function sougouPush(userId,userName,rank){
            var push = new ncmb.Push();
            push.set("immediateDeliveryFlag", true)
            .set("message", "あなたは現在「総合ランキング"+rank+"位」にノミネートしています！")
            .set("target", ["ios", "android"])
            .set('searchCondition', {
                    userObjectId: userId,
            });
            push.send()
            .then(function(push){
                    // 送信後処理
                    alertNew(rank+"位の"+userName+"様は成功");
            })
            .catch(function(err){
                    // エラー処理
                    alertNew(rank+"位は送信NG!!!");
            });
        }

        var myPageGiftCounter=0;
        function myPageRefresh(){
            $('#myPageBottom').on('inview',  function(event, isInView){
                if (isInView) {
                    console.log("other見えてる");
                    myPageGiftCounter++;
                    myPageGiftList(myPageGiftCounter);
                }else{
                    console.log("other見えてない");
                }
            });
        }
        // 保存後の処理
        // 保存後の処理
        $('#myFanfun').click(function(){
            var myFanfunURL = $('#myFanfunURL').val();
            instagramOpen(myFanfunURL);
        });

        $('#myTwitter').click(function(){
            var myTwitterURL = $('#myTwitterURL').val();
            instagramOpen(myTwitterURL);
        });
        $('#myInstagram').click(function(){
            var myInstagramURL = $('#myInstagramURL').val();
            instagramOpen(myInstagramURL);
        });
        $('#myYouTube').click(function(){
            var myYouTubeURL = $('#myYouTubeURL').val();
            instagramOpen(myYouTubeURL);
        });

        function giftLogStatusChange(logId){
            var arr = logId.split(',');
            console.log(arr);
            var giftLog = ncmb.DataStore("giftLog");
            alertNew(arr.length+"件見つけました");
            for(var i=0;i<arr.length;i++){
                giftLog
                .order('createDate', true)
                .equalTo('logId',arr[i])
                .fetch()         
                .then(function(result){
                    var logId = result.get("logId");
                    var buyUserId = result.get("buyUser");
                    var giftCreateInfluencer = result.get("giftCreateInfluencer");
                    console.log(result);
                    result.set("torihikiStatus", "プレゼント完了")
                            .update();
                    var push = new ncmb.Push();
                    push.set("immediateDeliveryFlag", true)
                    .set("message", "注文ID:"+logId+" がプレゼント完了しました！ご協力頂きありがとうございました！")
                    .set("target", ["ios", "android"])
                    .set('searchCondition', {
                            userObjectId: giftCreateInfluencer,
                    });
                    push.send()
                    .then(function(push){
                            //////////////////////////////
                            ///////// 購入者に通知
                            var push = new ncmb.Push();
                            push.set("immediateDeliveryFlag", true)
                            .set("message", "注文ID:"+logId+" がプレゼント完了しました！メールをご確認くださいませ！")
                            .set("target", ["ios", "android"])
                            .set('searchCondition', {
                                    userObjectId: buyUserId,
                            });
                            push.send()
                            .then(function(push){
                                    // 送信後処理
                                    alertNew("注文ID:"+logId+"成功");
                            })
                            .catch(function(err){
                                    // エラー処理
                                    alertNew("送信NG");
                            });
                    })
                    .catch(function(err){
                            // エラー処理
                            alertNew("送信NG");
                    });
                });
            }
        }

        function giftLogStatusKakunin(logId){
            var arr = logId.split(',');
            console.log(arr);
            var giftLog = ncmb.DataStore("giftLog");
            alertNew(arr.length+"件見つけました");
            for(var i=0;i<arr.length;i++){
                giftLog
                .order('createDate', true)
                .equalTo('logId',arr[i])
                .fetch()         
                .then(function(result){
                    var logId = result.get("logId");
                    var buyUserId = result.get("buyUser");
                    var giftCreateInfluencer = result.get("giftCreateInfluencer");
                    console.log(result);
                    result.set("torihikiStatus", "ギフト内容確認中")
                            .update();
                    var push = new ncmb.Push();
                    push.set("immediateDeliveryFlag", true)
                    .set("message", "注文ID:"+logId+" が「ギフト内容確認中」状態に変わりました！")
                    .set("target", ["ios", "android"])
                    .set('searchCondition', {
                            userObjectId: giftCreateInfluencer,
                    });
                    push.send()
                    .then(function(push){
                            //////////////////////////////
                            ///////// 購入者に通知
                            var push = new ncmb.Push();
                            push.set("immediateDeliveryFlag", true)
                            .set("message", "注文ID:"+logId+" が「ギフト内容確認中」状態に変わりました！")
                            .set("target", ["ios", "android"])
                            .set('searchCondition', {
                                    userObjectId: buyUserId,
                            });
                            push.send()
                            .then(function(push){
                                    // 送信後処理
                                    alertNew("注文ID:"+logId+"成功");
                            })
                            .catch(function(err){
                                    // エラー処理
                                    alertNew("注文ID:"+logId+"送信NG");
                            });
                    })
                    .catch(function(err){
                            // エラー処理
                            alertNew("注文ID:"+logId+"送信NG");
                    });
                }).catch(function(){
                    alertNew("注文ID:"+arr[i]+"は見つかりません");
                });
            }
        }
        
        function giftLogSearchInput(logId){
            var logId = String(logId);
            var giftLog = ncmb.DataStore("giftLog");
            giftLog
            .order('createDate', true)
            .equalTo('logId',logId)
            .fetch()         
            .then(function(results){
                document.getElementById('navi').bringPageTop('giftLogList.html');
                var object = results;
                var torihikiStatus = object.get("torihikiStatus");
                var objectId = object.get("objectId");
                var buyUser = object.get("buyUser");
                var buyUserNickName = object.get("buyUserNickName");
                var giftTitle = object.get("giftTitle");
                var giftCreateInfluencer = object.get("giftCreateInfluencer");
                console.log(torihikiStatus);
                setTimeout(function(){
                    $('#torihikiStatusBefore').val(torihikiStatus);
                    $('#kanriBuyId').val(buyUser);
                    $('#kanriNickName').val(buyUserNickName);
                    $('#kanriTitle').val(giftTitle);
                    $('#kanriInfluencerId').val(giftCreateInfluencer);
                    $('#kanriLogId').val(logId);
                    $('#kanriObjectId').val(objectId);
                },500);
            });
        }
        function userActionOpen(){
            $('.action-sheet-mask,.modal1').slideDown();
            // スクロールを無効にする
            $(window).on('touchmove.noScroll', function(e) {
                e.preventDefault();
            });
        }
        
        function userActionClose(){
            $('.action-sheet').slideUp();
            setTimeout(function(){
                $('.action-sheet-mask').slideUp();
            },500);
            // スクロール無効を解除する
            $(window).off('.noScroll');
        }

        function myShitagakiGift(){
            document.getElementById('navi').bringPageTop('myShitagakiGift.html');
            
            $('#myShitagakiGift').empty();

            var currentUser = ncmb.User.getCurrentUser();
            var objectId = currentUser.get("objectId");
            var userName = currentUser.get("userName");

            var GiftData = ncmb.DataStore("giftData");
            GiftData
            .order('createDate', true)
            .equalTo('ReleaseStatus',1)
            .equalTo('userId',objectId)
            .fetchAll()                
            .then(function(results){
                    var object = results;
                    for(var i=0;i<object.length;i++){
                            var gift_title = object[i].get("giftTitle");
                            var gift_text =object[i].get("giftText");
                            var create_date = object[i].get("releaseDate");
                            var time = jikanCulc(create_date);
                            var gift_uid = object[i].get("giftUid");
                            var gift_price = object[i].get("price");
                            var gift_stock = object[i].get("stock");
                            var gift_user_id = object[i].get("userId");
                            var ReleaseStatus = object[i].get("ReleaseStatus");
                            var ohitotu = object[i].get("ohitotu");
                            var auction = object[i].get("auction");
                            //カードに出力していく
                            var card = `
                            <div class="gift-card" style="width:48%;height: auto; padding: 1px 0 0 0;display: inline-block;margin-top:5px;"onclick="
                            `;
                            card += "giftIdJudge('"+gift_uid+"','"+userName+"','"+gift_title+"','"+gift_text+"','"+objectId+"','"+create_date+"','"+gift_price+"','"+gift_user_id+"','"+gift_stock+"','"+ReleaseStatus+"','"+ohitotu+"','"+auction+"');";
                            card +=`
                            ">
                                    <input class="gift_uid" type="" value="`;
                                    card += gift_uid;
                                    card += `
                                    " hidden>
                                    <div class="card" style="height:99%;margin:3px;border-radius:20px;">
                                            <div class="card__content" style="height:auto;">
                                                    <img id="`;
                                                    card += "search_gift_image_top_"+i;
                                                    card +=`"class="gift_image" src="" alt="" style="width:100%;height:154px;object-fit:cover;border-radius: 20px;">
                                            </div>
                                            <div class="card__content" style="height:45px;">
                                                    <ul class="list" style="background-image:none;background:transparent;margin-top:-13px;">
                                                    <li class="list-item" style="padding:0px;">
                                                            <div class="list-item__left" style="padding:0px;">
                                                            <img class="list-item__thumbnail" id="search_gift_user_image_top_`;
                                                            card += i;
                                                            card +=`" src="" alt="" style="border-radius: 50%;object-fit:cover;">
                                                            </div>
                                                    
                                                            <div class="list-item__center" style="padding:0px; padding-left:5px;">
                                                            <div id="search_gift_user_name_top_`;
                                                            card +=i;
                                                            card +=`" class="current_user_name" style="text-align: left;">
                                                            </div>
                                                            </div>
                                                    </li>
                                                    </ul>
                                            </div>
                                            <div class="gift_text" style="height:60px;font-size:12px;padding:5px;">
                                            `;
                                            card += gift_title;
                                            card += `
                                            </div>
                                            <div style="height:20px;">
                                                    <button class="toolbar-button" style="font-size:12px;padding:0px;">
                                                            <i id="`;
                                                            card += "search_gift_favorite_"+i;
                                                            card +=`"class="fas fa-heart favorite_off" style="font-size:12px;"></i> <span id="`;
                                                            card += "search_gift_favorite_span_"+i;
                                                            card +=`"class="favorite_off">0</span>
                                                    </button>
                                                    <button class="toolbar-button" style="font-size:12px;padding:0px;">
                                                            <span style="font-size:12px;color:gray">残:`;
                                                            card += gift_stock;
                                                            card +=`</span>
                                                    </button>
                                                    <button class="toolbar-button" style="font-size:12px;padding:0px;float: right;">
                                                            <span style="color:#898989">
                                                            `;
                                                            card += time;
                                                            card +=`
                                                            </span>
                                                    </button>
                                            </div>
                                    </div>
                            </div>
                            `;
                            $('#myShitagakiGift').append(card);
                            searchgiftUserGet(gift_user_id,i);
                            searchgiftImageGetTop(gift_uid,i);
                            searchgiftUserImageTop(gift_user_id,i);
                            searchgift_favorite_check(gift_uid,i);
                    }
                    syoryaku();
            })
            .catch(function(err){
                    console.log(err);
            });   
        }

        function giftLogStatusCancel(logId){
            var giftLog = ncmb.DataStore("giftLog");
            giftLog
            .order('createDate', true)
            .equalTo('logId',logId)
            .fetch()         
            .then(function(result){
                var logId = result.get("logId");
                var buyUser = result.get("buyUser");
                var giftCreateInfluencer = result.get("giftCreateInfluencer");
                var giftTitle = result.get("giftTitle");
                var giftUid = result.get("giftUid");
                var buyUserAtena = result.get("buyUserAtena");
                var buyUserNickName = result.get("buyUserNickName");
                var buyRequest = result.get("buyRequest");
                var buyKakaku = result.get("buyKakaku");
                var buyDate = result.get("buyDate");
                ncmb.User
                .equalTo("objectId",buyUser)
                .fetch()
                .then(function(result){
                    var buyUserMailAddress = result.get("mailAddress");
                    var buyUserName = result.get("userName");
                    ncmb.User
                    .equalTo("objectId",giftCreateInfluencer)
                    .fetch()
                    .then(function(result){
                        var influencerMailAddress = result.get("mailAddress");
                        var influencerName = result.get("userName");
                        console.log(influencerMailAddress,influencerName,buyUserMailAddress,buyUserName,logId,giftTitle,buyUserAtena,buyUserNickName,buyRequest,buyKakaku,buyDate);
                        $.ajax({
                            type: 'post',
                            url: 'https://fanfun2020.xsrv.jp/giftLogStatusCancel.html',
                            data: {
                                    "influencerMailAddress":influencerMailAddress,
                                    "influencerName":influencerName,
                                    "buyUserMailAddress":buyUserMailAddress,
                                    "buyUserName":buyUserName,
                                    "logId":logId,
                                    "giftTitle":giftTitle,
                                    "buyUserAtena":buyUserAtena,
                                    "buyUserNickName":buyUserNickName,
                                    "buyRequest":buyRequest,
                                    "buyKakaku":buyKakaku,
                                    "buyDate":buyDate,
                                    "giftUid":giftUid,
                            },
                            success: function(data){
                                console.log(data);
                                if(data == "success"){
                                    var GiftData = ncmb.DataStore("giftData");
                                    GiftData
                                    .equalTo("giftUid", giftUid)
                                    .fetch()               
                                    .then(function(result){
                                        var object = result;
                                        var stock = String(Number(object.get("stock")) + 1);
                                        result
                                        .set("stock",stock)
                                        .update();
                                        alertNew("在庫＋１完了");
                                    });
                                    var giftLog = ncmb.DataStore("giftLog");
                                    giftLog
                                    .equalTo('logId',logId)
                                    .fetch()         
                                    .then(function(result){
                                        result
                                        .delete()
                                        .then(function(){
                                            alertNew("ログ削除完了");
                                        });
                                    });
                                }
                            },
                            error: function (response) {
                                    console.log(response);
                            }
                        });
                    });
                });
            }).catch(function(){
                alertNew("注文ID:"+logId+"は見つかりません");
            });
        }

        function userReflesh(){
            var currentUser = ncmb.User.getCurrentUser();
            var objectId = currentUser.get("objectId");
            var mailaddress = currentUser.get("mailAddress");
            var password = currentUser.get("password");
            ncmb.User.loginWithMailAddress(mailaddress,password)
            .then(function(data){
                // ログイン後処理
                $('#myPageTab').click();
            })
        }
    </script>
    <style>
        .favorite_on{
            color:#FF6070;
        }
        .favorite_off{
            color:gray;
        }
    </style>
</ons-page>