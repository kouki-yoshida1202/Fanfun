<ons-page>
        <ons-toolbar class="toolbar" style="background-color: white;">
                <div class="left" style="padding-left: 3%;">
                        <ons-back-button></ons-back-button>
                </div>
                <div class="center" style="width:120%;color:#898989;">
                        ギフトログ検索
                </div>
        </ons-toolbar>
        
        <div class="contents" style="margin:5px;">
                <input type="text" readonly id="kanriObjectId" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>ログID</span>
                <input type="text" readonly id="kanriLogId" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>タイトル</span>
                <input type="text" readonly id="kanriTitle" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>ニックネーム</span>
                <input type="text" readonly id="kanriNickName" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>購入者</span>
                <input type="text" readonly id="kanriBuyId" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>インフルエンサー</span>
                <input type="text" readonly id="kanriInfluencerId" class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                <span>状態</span>
                <input type="text" readonly id="torihikiStatusBefore"class="text-input" style="background-color: white;border:1px solid black;width:100%;">
                
                <select id="torihikiStatusAfter" class="select-input">
                        <option val="ギフト準備中">ギフト準備中</option>
                        <option val="ギフト内容確認中">ギフト内容確認中</option>
                        <option val="プレゼント完了">プレゼント完了</option>
                        <option val="入金待ち">入金待ち</option>
                        <option val="保留中">保留中</option>
                </select>

                <button class="btn button" onclick="torihikiStatusChange();">変更</button>
        </div>
        <!-- 以下、javascript -->
        <script type="text/javascript">
                function torihikiStatusChange(){
                        var kanriObjectId = $('#kanriObjectId').val();
                        var torihikiStatusBefore = $('#torihikiStatusBefore').val(); 
                        var torihikiStatusAfter = $('#torihikiStatusAfter').val(); 
                        var kanriLogId = $('#kanriLogId').val();
                        var kanriBuyId = $('#kanriBuyId').val();
                        var kanriInfluencerId = $('#kanriInfluencerId').val();

                        var giftLog = ncmb.DataStore("giftLog");
                        giftLog
                        .equalTo('objectId',kanriObjectId)
                        .fetch()         
                        .then(function(results){
                                results.set("torihikiStatus", torihikiStatusAfter)
                                        .update();
                                if(torihikiStatusBefore=="入金待ち" && torihikiStatusAfter=="ギフト準備中"){
                                        ////////////////////////////
                                        ///////// 出品者に通知
                                        var push = new ncmb.Push();
                                        push.set("immediateDeliveryFlag", true)
                                        .set("message", "注文ID:"+kanriLogId+" の入金が確認されました！ギフトの準備をお願いします！")
                                        .set("target", ["ios", "android"])
                                        .set('searchCondition', {
                                                userObjectId: kanriInfluencerId,
                                        });
                                        push.send()
                                        .then(function(push){
                                                //////////////////////////////
                                                ///////// 購入者に通知
                                                var push = new ncmb.Push();
                                                push.set("immediateDeliveryFlag", true)
                                                .set("message", "注文ID:"+kanriLogId+" の入金が確認され、「ギフト準備中」状態となりました！")
                                                .set("target", ["ios", "android"])
                                                .set('searchCondition', {
                                                        userObjectId: kanriBuyId,
                                                });
                                                push.send()
                                                .then(function(push){
                                                        // 送信後処理
                                                        alertNew("送信OK");
                                                        document.getElementById('navi').popPage();
                                                })
                                                .catch(function(err){
                                                        // エラー処理
                                                        alertNew("送信NG");
                                                });
                                        })
                                        .catch(function(err){
                                                // エラー処理
                                                alertNew("送信NG");
                                        });
                                }else if(torihikiStatusAfter=="プレゼント完了"){
                                        ////////////////////////////
                                        ///////// 出品者に通知
                                        var push = new ncmb.Push();
                                        push.set("immediateDeliveryFlag", true)
                                        .set("message", "注文ID:"+kanriLogId+" がプレゼント完了しました！ご協力頂きありがとうございました！")
                                        .set("target", ["ios", "android"])
                                        .set('searchCondition', {
                                                userObjectId: kanriInfluencerId,
                                        });
                                        push.send()
                                        .then(function(push){
                                                //////////////////////////////
                                                ///////// 購入者に通知
                                                var push = new ncmb.Push();
                                                push.set("immediateDeliveryFlag", true)
                                                .set("message", "注文ID:"+kanriLogId+" がプレゼント完了しました！メールをご確認くださいませ！")
                                                .set("target", ["ios", "android"])
                                                .set('searchCondition', {
                                                        userObjectId: kanriBuyId,
                                                });
                                                push.send()
                                                .then(function(push){
                                                        // 送信後処理
                                                        alertNew("送信OK");
                                                        document.getElementById('navi').popPage();
                                                })
                                                .catch(function(err){
                                                        // エラー処理
                                                        alertNew("送信NG");
                                                });
                                        })
                                        .catch(function(err){
                                                // エラー処理
                                                alertNew("送信NG");
                                        });
                                }else{
                                        ////////////////////////////
                                        ///////// 出品者に通知
                                        var push = new ncmb.Push();
                                        push.set("immediateDeliveryFlag", true)
                                        .set("message", "注文ID:"+kanriLogId+" が「"+torihikiStatusAfter+"」状態に変わりました！")
                                        .set("target", ["ios", "android"])
                                        .set('searchCondition', {
                                                userObjectId: kanriInfluencerId,
                                        });
                                        push.send()
                                        .then(function(push){
                                                ////////////////////////////
                                                // 購入者に通知
                                                var push = new ncmb.Push();
                                                push.set("immediateDeliveryFlag", true)
                                                .set("message", "注文ID:"+kanriLogId+" が「"+torihikiStatusAfter+"」状態に変わりました！")
                                                .set("target", ["ios", "android"])
                                                .set('searchCondition', {
                                                        userObjectId: kanriBuyId,
                                                });
                                                push.send()
                                                .then(function(push){
                                                // 送信後処理
                                                        alertNew("送信OK");
                                                        document.getElementById('navi').popPage();
                                                })
                                                .catch(function(err){
                                                        // エラー処理
                                                        alertNew("送信NG");
                                                });
                                        })
                                        .catch(function(err){
                                                // エラー処理
                                                alertNew("送信NG");
                                        });
                                }
                                
                        }).catch(function(){
                                alertNew("更新失敗");
                        });
                }
        </script>
</ons-page>