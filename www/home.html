<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src * fanfun: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'"> -->
  <meta http-equiv="Content-Security-Policy" content="default-src * fanfun: data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src * coolapp: data:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'"> -->

  <script src="components/loader.js"></script>
  <script src="https://smtpjs.com/v3/smtp.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>
  <script src="https://kit.fontawesome.com/1cca0b75e5.js" crossorigin="anonymous"></script>
  <link href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" rel="stylesheet">

  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">
  <!-- <link rel="stylesheet" href="css/modal.css"> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.css">
  <!-- <link rel="stylesheet" href="https://unpkg.com/swiper/css/swiper.min.css"> -->
  <script src="https://unpkg.com/swiper/js/swiper.js"></script>
  <!-- <script src="https://unpkg.com/swiper/js/swiper.min.js"></script> -->
  <script src="lib/onsenui/js/logout.js"></script>
  <script src="lib/onsenui/js/currentuser.js"></script>
  <script src="lib/onsenui/js/profileEdit.js"></script>
  <script src="lib/onsenui/js/giftInfo.js"></script>
  <script src="lib/onsenui/js/userGift.js"></script>
  <!-- <script src="lib/onsenui/js/kyujosyo.js"></script>/ -->
  <script src="lib/onsenui/js/shintyaku.js"></script>
  <script src="lib/onsenui/js/followGiftList.js"></script>
  <script src="lib/onsenui/js/otherPage.js"></script>
  <script src="lib/onsenui/js/follow.js"></script>
  <!-- <script src="lib/onsenui/js/bellList.js"></script> -->
  <script src="lib/onsenui/js/gift_favorite.js"></script>
  <script src="lib/onsenui/js/other_gift_favorite.js"></script>
  <!-- <script src="lib/onsenui/js/message.js"></script> -->
  <!-- <script src="lib/onsenui/js/modal.js"></script> -->
  <script src="lib/onsenui/js/houkoku.js"></script>
  <script src="lib/onsenui/js/instagram.js"></script>
  <script src="lib/onsenui/js/searchGift.js"></script>
  <script src="lib/onsenui/js/buypage.js"></script>
  <script src="lib/onsenui/js/influencerChangeKiyaku.js"></script>
  <script src="lib/onsenui/js/influencerChange.js"></script>
  <!-- <script src="lib/onsenui/js/mailSend.js"></script> -->
  <!-- <script src="lib/onsenui/js/orderEnd.js"></script> -->
  <script src="lib/onsenui/js/myFavoriteGift.js"></script>
  <script src="lib/onsenui/js/orderCheck.js"></script>
  <script src="lib/onsenui/js/pull-to-reload.min.js"></script>
  <!-- <script src="lib/onsenui/js/log.js"></script> -->
  <!-- <script src="lib/onsenui/js/test.js"></script> -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/2.0.1/TweenMax.min.js"></script>
  <script src="lib/onsenui/js/wavify.js"></script>
  <script src="lib/onsenui/js/jquery.wavify.js"></script>
  <script src="lib/onsenui/js/contactForm.js"></script>
  <script src="lib/onsenui/js/requestForm.js"></script>
  <script src="lib/onsenui/js/loadingoverlay.min.js"></script>
  <script src="lib/onsenui/js/giftLog.js"></script>
  <script src="lib/onsenui/js/crown.js"></script>
  <script src="lib/onsenui/js/jquery.inview.min.js"></script>
  <script src="lib/onsenui/js/searchUser.js"></script>
  <script src="lib/onsenui/js/moment.js"></script>
  <!-- <script src="lib/onsenui/js/fileUpload.js"></script> -->

  <script>
    // ログインしたらまずTopページにくるようにTopのアイコンを押す
    ons.ready(function() {
      $('#topPageTab').click();
    });
    // dataURIをBlobに変換する関数
    function toBlob(dataURI){
        const byteString = atob( dataURI.split( "," )[1] ) ;
        const mimeType = dataURI.match( /(:)([a-z\/]+)(;)/ )[2] ;
        for( var i=0, l=byteString.length, content=new Uint8Array( l ); l>i; i++ ) {
            content[i] = byteString.charCodeAt( i ) ;
        }
        return new Blob( [ content ], {
            type: mimeType ,
        }) ;
    }
    var osVer ="Android";
    var osVer2 = "iPhone";
    if(navigator.userAgent.indexOf(osVer)>0 || navigator.userAgent.indexOf(osVer2)>0){
      applicationKey="2a769bb0b55358cb641215e139e1e4c409bfba09b1177e468e736635af5c7f58";
      clientKey="e007abb894e7e571efd683ba05b19e90ed4bb3633cf8e693f287451bb4d1db06";
      NCMB.monaca.setDeviceToken(
        applicationKey,
        clientKey,
        (result) => {
          console.log(result);
        },
        (err) => console.log("通知設定エラー："+JSON.stringify(err))
      );
    }
    // 通知クラスにobjectIdを入れる
    setTimeout((function(){
      getInstallationId();
    }), 5000);
    setTimeout((function(){
      getInstallationId();
    }), 10000);
    function getInstallationId(){
      NCMB.monaca.getInstallationId(id => {
        ncmb.Installation
          .equalTo('objectId', id)
          .fetch()
          .then((installation) => {
              var currentUser = ncmb.User.getCurrentUser();
              var objectId = currentUser.get('objectId');
              var userName = currentUser.get('userName');
              installation
              .set('userObjectId',objectId)
              .set('userName',userName)
              .update();
          })
          .catch(err => console.log("通知設定エラー："+JSON.stringify(err)));
      });
    }

    function handleOpenURL(url) {
      setTimeout(function() {
        var strValue = decodeURIComponent(url);
        var urlPrm = [];
        strValue = strValue.replace('fanfun://','');
        var urlSearch = strValue.substring(1).split('&');
        for(i=0;urlSearch[i];i++) {
          var kv = urlSearch[i].split('=');
          urlPrm[kv[0]]=kv[1];
        }
        var page = urlPrm.page;

        if(page=="giftPage"){
          var gift_uid = urlPrm.GIFTorUSERID;
          var GiftData = ncmb.DataStore("giftData");
          GiftData
          .equalTo("giftUid", gift_uid)
          .fetch()               
          .then(function(results){
            var object = results;
            var gift_title = object.get("giftTitle");
            var gift_text = object.get("giftText");
            var price = object.get("price");
            var create_date = object.get("createDate");
            var gift_user_id = object.get("userId");
            var gift_stock = object.get("stock");
            var ReleaseStatus = object.get("ReleaseStatus");
            var currentUser = ncmb.User.getCurrentUser();
            var userName = currentUser.get("userName");
            var mailaddress = currentUser.get("mailAddress");
            var objectId = currentUser.get("objectId");
            var ohitotu = object.get("ohitotu");
            // アラートで確認
            giftIdJudge(gift_uid,userName,gift_title,gift_text,objectId,create_date,price,gift_user_id,gift_stock,ReleaseStatus,ohitotu);
          })
          .catch(function(err){
                  // エラー処理
                  alert("情報取得に失敗しました。");
                  window.location.href = 'home.html';
          });
        }else if(page=="userPage"){
          var currentUser = ncmb.User.getCurrentUser();
          var objectId = currentUser.get("objectId");
          var other_user_id = urlPrm.GIFTorUSERID;
          if(objectId == other_user_id){
            $('#myPageTab').click();
          }else{
            document.getElementById('navi').bringPageTop('otherpage.html');
            otherPageUserId(userId);
          }
        }else if(page=="cardBuy"){
          showLoad();
          var date = getNowYMD();
          var defaultPrice = urlPrm.defaultPrice;
          var request = urlPrm.request;
          var sendHuman = urlPrm.sendHuman;
          var nickName = urlPrm.nickName;
          var giftUid = urlPrm.giftUid;
          var tyumonId = urlPrm.tyumonId;
          var objectId = urlPrm.objectId;
          var influencerId = urlPrm.influencerId;
          var giftTitle = urlPrm.giftTitle;

          var giftLog = ncmb.DataStore("giftLog");
          var giftLog = new giftLog();
          giftLog.set("buyDate",date)
                  .set("buyKakaku",defaultPrice)
                  .set("buyRequest",request)
                  .set("buyUser",objectId)
                  .set("buyUserAtena",sendHuman)
                  .set("buyUserNickName",nickName)
                  .set("giftCreateInfluencer",influencerId)
                  .set("giftTitle",giftTitle)
                  .set("giftUid",giftUid)
                  .set("logId",tyumonId)
                  .set("torihikiStatus","ギフト準備中")
                  .save()
                  .then(function(){
                    // 保存後の処理
                    var GiftData = ncmb.DataStore("giftData");
                    GiftData.equalTo("giftUid", giftUid)
                            .fetch()                
                            .then(function(results){
                                    var object = results;
                                    var num = object.get("stock");
                                    num = String(Number(num)-1);
                                    results.set("stock", num).update();
                                    return results;
                            })
                            .then(function(){
                              hideLoad();
                              setTimeout(function(){
                                alert("手続きが完了しました");
                                window.location.href = 'home.html';
                              },500);
                            })
                            .catch(function(err){
                              hideLoad();
                            });
                  })
                  .catch(function(err){
                    // エラー処理
                    hideLoad();
                  });
        }
      }, 0);
    }

    function getNowYMD(){
      var dt = new Date();
      var y = dt.getFullYear();
      var m = ("00" + (dt.getMonth()+1)).slice(-2);
      var d = ("00" + dt.getDate()).slice(-2);
      var result = y + "/" + m + "/" + d;
      return result;
    }
    // フォローリスト、フォロワーリストから、フォローやフォロワーを解除するダイアログ表示用
    var createAlertDialog = function() {
      var dialog = document.getElementById('my-alert-dialog');

      if (dialog) {
        dialog.show();
      } else {
        ons.createElement('alert-dialog.html', { append: true })
          .then(function(dialog) {
            dialog.show();
          });
      }
    };
    var hideAlertDialog = function() {
      document
        .getElementById('my-alert-dialog')
        .hide();
    };
    function homeback(){
      window.location.href = 'home.html'
    }

    function showLoad(){
        $("body").LoadingOverlay("show", {
                image       : "",
                fontawesome : "fa fa-refresh fa-spin",
        });
    }

    function hideLoad() {
            $("body").LoadingOverlay("hide");
    };

    function showUserLoad(){
        $("#myGiftList").LoadingOverlay("show", {
                image       : "",
                fontawesome : "fa fa-refresh fa-spin",
        });
    }

    function hideUserLoad() {
            $("#myGiftList").LoadingOverlay("hide");
    };

    if (ons.platform.isIPhoneX()) {
      document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
      document.documentElement.setAttribute('onsflag-iphonex-landscape', '');
    }

    function osCheck(link){
      osVer = "Android";
      if(navigator.userAgent.indexOf(osVer)>0){
          console.log("android");
          androidWindow(link);/*特定の端末だった時に呼ばれる関数*/
      }else{
          console.log("androidじゃない");
          aiueo(link);
      }
    }
    function aiueo(link){
      // どっちか使う
      window.open(link, '_blank', 'location=yes');
      return false;
    }
    function androidWindow(link) {
      console.log("android");
      window.open(link, "_system", 'location=yes');
    }
    function share(ID,page){
      navigator.screenshot.URI(function(error,res){
        if(error){
          console.error(error);
          return;
        }
        window.plugins.socialsharing.share(
        '「Fanfun」でギフトがもらえるよ！ #Fanfun',          // ツイートなどのシェアするテキスト
        'ファイル名',                // Androidの場合はファイル名を指定する
        res.URI,                  // base64エンコードされたスクショ画像
        'https://fanfun2020.xsrv.jp/customUrlScheme.html?GIFTorUSERID='+ID+'&page='+page);                    //shareするURL
      });
    }
    function passwordReminder(){
        var reminder_mail = $('#reminder_mail').val();
        var user = new ncmb.User();

        var mailcheck = MailCheck(reminder_mail);
        if(mailcheck){
            user.set("mailAddress", reminder_mail);
            user.requestPasswordReset()
                .then(function(data){
                    // 送信後処理
                    reminderMailOpen();
                })
                .catch(function(err){
                    // エラー処理
                    alert("受付エラーです。お問い合わせください。");
                });
        }else{
            reminderMailMissOpen();
        }
    }
    document.addEventListener("init", function(event) {

          // トップページにて、上下スクロール中は上部のメニューを非表示
          $(window).on('scroll touchmove',function() {
            $(".swiper-navigation").stop(); //アニメーションしている場合、アニメーションを強制停止
			      $(".swiper-navigation").css('display', 'none').delay(500).fadeIn('fast');
          });

          //このあたりはswiper.jsというライブラリのサンプルを結構そのまま持ってきたので、何をやっているか具体的にまでわかりません。
          function setCurrentSlide(ele, index) {
            $(".swiper-navigation .swiper-slide").removeClass('selected');
            ele.addClass('selected');
          }
          swiperNavigation = new Swiper('.swiper-navigation', {
            slidesPerView: 'auto',
            allowTouchMove: false,
            freeMode: false,
            loop: false,
            autoplay: false
          });


          swiperContents = new Swiper('.swiper-contents', {
            direction: 'horizontal',
            loop: false,
            autoHeight: true
          });
          swiperContents.on('slideChange', function() {
            setTimeout(function(){
              var index = $('div.sp-content > div.swiper-slide-active').index();
              slideControl(index);
              setCurrentSlide($('.swiper-navigation .swiper-slide').eq(index), index);
              // swiperNavigation.slideTo(index, 500, false);
            },250);
          });
          
          // $('.sp-slide').click(function(){
          //   var index = $('.sp-slide').index(this);
          //   swiperContents.slideTo(index, 100, false);
          // });
          
          var header_icon = $('.toolbar').height();
          header_icon = header_icon -5;
          $('.header_icon').width(header_icon);
          $('.header_icon').height(header_icon);
          header_icon = header_icon -5;
          $('.search-input').height(header_icon);

          // ヘッダーの高さ分、メインコンテンツのmargin-topをつける
          var header_height = $('.header').height();
          $('.contents').css('margin-top',header_height);
        
          // ギフトタイトルがボックスをはみ出さないようにsyoraku関数で、はみ出す部分は…表示にしている
          syoryaku();
          
      });
      function homeJudge(){
        setTimeout(function(){
          var index = $('.selected').index('div.sp-navi div');
          if(index == 0){
            shintyaku(0);
          }else if(index==1){
            followUserGift();
          }
        },500);
      }

      var slideCounter = 0;
      function slideControl(index){
        slideCounter++;
        console.log(slideCounter);
        if(slideCounter == 1){
          if(index == 0){
            //新着にメニューがうつると、新着ギフトをロード
            shintyaku(0);
          }else if(index==1){
            followUserGift();
          }
        }
        // setTimeout(function(){
        //   slideCounter = 0;
        //   console.log(slideCounter);
        // },1000);       
      }

      var homeCounter = 0;
      homeCounter++;
      if(homeCounter==1){
        homeJudge();
        loginImage();
      }
  </script>
  <style>
    *{
      -webkit-overflow-scrolling: touch;
    }
    .alert-dialog-mask{
      position:fixed;
    }
    .card{
      padding:5px 10px 5px 10px;
    }

    .gift-card{
      float: left;
    }
    .follow_on{
      background:gray !important;
      border-radius:20px;
    }

    .fa-refresh{
      font-size:40px;
    }

    .follow_off{
      background: -moz-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: -webkit-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: linear-gradient(to top right, #FF1048, #FFAA95);
      border-radius:20px;
    }
    .navi-menu{
      padding:5px 20px 3px 20px;
      font-size:80%;
      line-height:35px;
      color:#898989;
    }
    .segment__button{
      margin:0 auto;
      width:100%;
      font: 15px/24px sans-serif;
      border-radius: 20px !important;
      border:none;
      color:#898989;
    }

    :checked + .segment__button{
      background: -moz-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: -webkit-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: linear-gradient(to top right, #FF1048, #FFAA95);
    }

    .button{
      background: -moz-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: -webkit-linear-gradient(bottom left, #FF1048, #FFAA95); 
      background: linear-gradient(to top right, #FF1048, #FFAA95);
    }

    .button-gray{
      height:70%;
      border-radius: 20px;
      margin-right:10px;
      font-size:80%;
      padding:0px 20px 0px 20px;
      background: white;
      border:1px solid #898989;
      color:white;
    }
    :checked + .tabbar__button{
      color: #FF6070;
    }

    .header{
      position: fixed;
      top: 0;
      left:0;
      width:100%;
      z-index: 100;
    }

    .swiper-slide{
      width:50%;
      text-align: center;
    }

    .back-button,.back-button__icon{
      color:#898989;;
      fill:#898989;
    }

    .sp-navi > .selected > span{
      color:#FF6070;
      border-bottom: 2px solid #FF6070;
      font-weight: bold;
      /* border-bottom:0.5px solid #FF6070; */
      /* background: #FF6070; */
      /* border-radius: 30px; */
    }

    .footer{
      position: fixed;
      bottom: 0;
      left:0;
      height:35px;
      width: 100%; /* フッターの横幅を指定する */
      z-index: 100;
    }
    
    .tabbar__icon > .fa{
      font-size:20px;
    }

    .follow_thumbnanil{
      width:50px;
      height:50px;
    }
    
    .current_user_name{
      margin-top:8px;
    }

    .fa-crown{
      font-size:18px !important;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <ons-navigator id="navi" swipeable="force">
    <ons-page>
      <ons-tabbar position="bottom">
          <ons-tab id="topPageTab"page="top.html" label="ホーム"icon="home" onclick="" active></ons-tab>
          <ons-tab page="crown.html" label="ランキング" icon="crown" onclick="crown();"></ons-tab>
          <ons-tab page="instagram.html" label="ニュース"icon="instagram" onclick="InstagramNews();"></ons-tab>
          <!-- <ons-tab page="pointList.html" label="ショップ"icon="ticket" onclick=""></ons-tab> -->
          <ons-tab label="コンタクト"page="request.html" icon="fa-rocketchat" onclick=""></ons-tab>
          <ons-tab label="出品/購入"page="shop.html" icon="fa-yen-sign" onclick="shopPushPage();"></ons-tab>
          <!-- <ons-tab page="bell.html" label="通知"icon="bell" onclick="bellList();"></ons-tab> -->
          <ons-tab id="myPageTab" label="マイページ"page="user.html" icon="user" onclick="MyGift();loginInfo();"></ons-tab>
      </ons-tabbar> 
    </ons-page>
  </ons-navigator> 
</body>
</html>
