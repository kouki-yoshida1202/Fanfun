<ons-page>
        <style>
                .cp_iptxt {
                        position: relative;
                        margin: 15px 3%;
                }
                .cp_iptxt input{
                        font: 15px/24px sans-serif;
                        box-sizing: border-box;
                        width: 100%;
                        margin: 8px 0;
                        padding: 0.3em;
                        transition: 0.3s;
                        border: 1px solid #898989;
                        border-radius: 4px;
                        outline: none;
                }
                .cp_iptxt input:focus {
                        border-color: #FF6070;
                }
                .cp_iptxt input{
                        padding-left: 40px;
                }
                .cp_iptxt i {
                        position: absolute;
                        top: 11px;
                        left: 0;
                        padding: 9px 8px;
                        transition: 0.3s;
                        color: #aaaaaa;
                }
                .cp_iptxt input:focus + i {
                        color: #FF6070;
                }
        </style>
        <ons-toolbar class="toolbar" style="background-color: white;">
                <div class="left" style="padding-left: 3%;">
                        <ons-back-button id="contactFormBackButton"></ons-back-button>
                </div>
                <div class="center" style="color:#898989;">
                        投げ銭設定画面
                </div>
        </ons-toolbar>
        <div id="" class="container contents" style="position:relative;">
                <input type="hidden" id="logIdNagesen">
                <input type="hidden" id="sendUserNagesen">
                <input type="hidden" id="receiveUserNagesen">
                <input type="hidden" id="giftUidNagesen">
                <!-- カードリスト部分 -->
                <div style="height: auto;width:100%;margin:0 auto;margin-bottom:200px;">
                        <div class="card" style="text-align: center;">
                                <div class="card__content"style="text-align:left;font-size:12px;">
                                        <div id="oreichatKakunin"class="cp_iptxt">
                                        </div>
                                        <div class="cp_iptxt">
                                                <input type="tel" placeholder="投げ銭額(100円単位で入力ください)" id="nagesengaku" required>
                                                <i class="fas fa-piggy-bank fa-lg fa-fw" aria-hidden="true"></i>
                                        </div>
                                        <div style="width:100%;text-align:center;margin:0 auto;margin-top:20px;margin-bottom:20px;">
                                                <p style="text-align: left;width:95%;margin:0 auto;color:gray;">
                                                        1. 送信後、相手様に通知が飛びます(通知ONの場合)。<br>
                                                        2. 送信後、内容の変更は出来ません。<br>
                                                        3. 内容によっては無断でメッセージを削除する場合がございます。<br>
                                                        4. 相手様からのお返事は原則ございません。<br>
                                                </p>
                                                <br>
                                                <button class="button "style="width:100%;padding-top:0px;padding-bottom:0px;line-height:40px;border-radius:30px;font-size:16px;margin:0 auto;" onclick="nagesenStripe();">カード払い(手数料4%)</button>
                                                <br>
                                                <p style="text-align: left;width:95%;margin:0 auto;color:#FF6070;padding-top:5px;">
                                                        「投げ銭額×1.5」がファンpointに加算されます！
                                                </p>
                                        </div>
                                </div>
                        </div>
                </div>  
        </div>
        <script>
                function nagesenStripe(){
                        var logId = $('#logIdNagesen').val();
                        var sendUser = $('#sendUserNagesen').val();
                        var receiveUser = $('#receiveUserNagesen').val();
                        var giftUid = $('#giftUidNagesen').val();
                        var messageText = $('#oreichatKakunin').html();
                        var nagesengaku = Number($('#nagesengaku').val());
                        if(nagesengaku == ''){
                                alertNew("投げ銭額を入力してください");
                        }else if(!Number.isInteger(nagesengaku) || nagesengaku < 1){
                                alertNew("1以上の整数で入力してください","","");
                        }else if(nagesengaku%100 != 0){
                                alertNew("100円単位(下2桁が00)で設定してください");
                        }else{
                                var giftLog = ncmb.DataStore("giftLog");
                                giftLog
                                .equalTo("logId", logId)
                                .fetch()               
                                .then(function(results){
                                        var buyRequest = results.get("buyRequest");
                                        var giftTitle = results.get("giftTitle");
                                        var buyUserNickName = results.get("buyUserNickName");
                                        var buyUserAtena = results.get("buyUserAtena");
                        
                                        // 送り手のニックネーム取得
                                        ncmb.User
                                        .equalTo('objectId',sendUser)
                                        .fetch()
                                        .then(function(results){
                                                var object = results;
                                                var sendUserName = object.get("userName");
                                                var sendUserMail = object.get("mailAddress");

                                                ncmb.User
                                                .equalTo('objectId',receiveUser)
                                                .fetch()
                                                .then(function(results){
                                                        var object = results;
                                                        var receiveUserName = object.get("userName");
                                                        var receiveUserMail = object.get("mailAddress");
                                                        var nagesenTesuryo = nagesengaku*1.04;
                                                        androidWindow('https://fanfun2020.xsrv.jp/nagesenButton.html?logId='+logId+'&sendUser='+sendUser+'&receiveUser='+receiveUser+'&giftUid='+giftUid+'&messageText='+messageText+'&nagesengaku='+nagesengaku+'&buyRequest='+buyRequest+'&giftTitle='+giftTitle+'&buyUserNickName='+buyUserNickName+'&buyUserAtena='+buyUserAtena+'&sendUserName='+sendUserName+'&sendUserMail='+sendUserMail+'&receiveUserName='+receiveUserName+'&receiveUserMail='+receiveUserMail+'&nagesenTesuryo='+nagesenTesuryo);
                                                })
                                                .catch(function(err){
                                                        alertNew("エラーが発生しました。もう一度やり直してください。","","");
                                                });
                                        })
                                        .catch(function(err){
                                                alertNew("エラーが発生しました。もう一度やり直してください。","","");
                                        });
                                })
                                .catch(function(err){
                                        alertNew("エラーが発生しました。もう一度やり直してください。","","");
                                });
                        }
                }
        </script>
</ons-page>