<ons-page>
    <ons-toolbar class="toolbar" style="background-color: white;position: fixed;">
        <div class="left" style="padding-left: 3%;">
            <ons-back-button></ons-back-button>
        </div>
        <div class="center" style="color:#898989;">
            ギフト詳細
        </div>
        <div class="right" style="padding-right: 5%;"onclick="mygiftAction();">
            <i class="fas fa-ellipsis-h"></i>
        </div>
    </ons-toolbar>
    <input type="hidden" id="my_user_id">
    <input type="hidden" id="my_gift_id">
    <input type="hidden" id="ReleaseStatus">
    <input type="hidden" id="prev_page">
    <div class="container contents" style="background-color:#efeff4;padding-bottom:50px;">
        <!-- カードリスト部分 -->
        <div class="" style="width:100%;height: auto; padding: 1px 0 0 0;display: inline-block;">
            <div class="card" style="height:99%;margin:3px;border-radius:20px;padding:10px 20px 10px 20px;">
                <div class="card__content" style="position: absolute;top:10;left:10;width:auto;min-width:50px;height:40px;border-radius: 20px 0px 20px 0px;color:white;text-align: center;background: -moz-linear-gradient(bottom left, #FF1048, #FFAA95);background: -webkit-linear-gradient(bottom left, #FF1048, #FFAA95);background: linear-gradient(to top right, #FF1048, #FFAA95);padding-right:10px;padding-left:10px;">
                    <span id="zaikoMyDetail" style="line-height: 40px;">
                        残り：<span id="my_stock"></span>
                    </span>
                </div>
                <div id="gift_detail_image_zone" class="card__content" style="">
                    <img id="gift_detail_image"class="gift_image_detail" src="img/loading.png" alt="" style="width:100%;height:329px;object-fit:cover;border-radius: 20px;">
                </div>
                <div class="card__content" style="height:auto;z-index:100;margin-top:-20px;">
                    <ul class="list" style="background-image:none;">
                    <li class="list-item" style="padding:0px;">
                        <div class="list-item__left" style="padding:0px;">
                            <img id="gift_detail_user_image"class="list-item__thumbnail" src="img/human.png" alt="" style="border-radius: 50%;width:60px;height:60px;object-fit:cover;">
                        </div>
                    
                        <div class="list-item__center" style="padding:0px; padding-left:10px;">
                            <div id="gift_detail_username"class="" style="margin-top:20px;font-size: 20px;color:#898989;"></div>
                        </div>
                    </li>
                    </ul>
                </div>
                <div class="gift_icon" style="height:45px;font-size:12px;padding:5px;margin-top:8px;">
                    <div style="width:33%;float:left;text-align: center;"onclick="my_gift_favorite_button();">
                        <i id="my_gift_favorite_status" class="fa fa-heart favorite_off" style="font-size:20px;"></i>
                        <br>
                        <span id="my_gift_favorite_count" style="font-size:14px;color:#898989;">0</span>
                    </div>
                    <div class="" style="width:33%;float:left;text-align: center;" onclick="share($('#my_gift_id').val(),'giftPage');">
                        <i class="fab fa-hubspot" style="font-size:20px;color:gray;"></i>
                        <br>
                        <span style="font-size:14px;color:#898989;">共有</span>
                    </div>
                    <div class="" style="width:33%;float:left;text-align: center;" onclick="mygiftHoukoku();">
                        <i class="fab fa-font-awesome-flag"style="font-size:20px;color:gray;"></i>
                        <br>
                        <span style="font-size:14px;color:#898989;">報告</span>
                    </div>
                </div>
                <div id="gift_detail_title"class="gift_title" style="height:auto;font-size:16px;font-weight:bold;padding:10px 5px 10px 5px;"></div>
                <div id="mygift_detail_ohitotu" style="display: none;">
                    <span style="background-color: #FF6070;color:white;font-weight:bold;border-radius: 20px;padding:5px 10px;font-size:0.7em;">お一人様おひとつ限定</span>
                </div>
                <div id="mygift_detail_auction" style="display: none;">
                    <span style="background-color: #FF6070;color:white;font-weight:bold;border-radius: 20px;padding:5px 10px;font-size:0.7em;">オークション商品</span>
                </div>
                <div id="mygift_detail_fanpresent" style="display: none;margin:5px 0px;">
                    <span style="background-color: #FF6070;color:white;font-weight:bold;border-radius: 20px;padding:5px 10px;font-size:0.7em;">Fanランキング上位者限定ギフト！</span>
                </div>
                <div id="gift_text_fanPresent_date"class="gift_text_fanPresent_date" style="height:auto;font-size:0.7em;padding:10px 5px 10px 5px;display:none;color:#898989;"></div>
                <div id="gift_detail_text"class="gift_text" style="height:auto;font-size:14px;padding:10px 5px 10px 5px;"></div>
                <div id="gift_detail_time"class="gift_time" style="text-align:right;height:auto;font-size:10px;padding:10px 5px 10px 5px;"></div>
                <div id="gift_detail_ReleaseStatus"class="" style="display: none;width:100%;text-align: center;padding:15px 10px;">
                    下書き状態です
                </div>
            </div>
        </div>
    </div>
    <div class="tabbar" style="background-color: #4B4B4B;position: fixed;bottom:0;left:0;">
        <div class="right" style="width:60%;float: left;color:white;padding-left:7%;">
            <span id="gift_detail_price" style="font-size: 24px;line-height:45px;"></span>
        </div>
        <div class="right" style="width:40%;padding-right:7%;">
            <button class="button" style="background-color: #FF6070;width:100%;"onclick="document.getElementById('navi').bringPageTop('myGiftEdit.html');giftNowInfo();">
                編集する
            </button>
        </div>
    </div>
    <div class="action-sheet-mask mygift_option_mask"></div>
    <div id="option_modal" class="action-sheet mygift_option_modal">
        <button id="shitagakiButton" class="action-sheet-button" onclick="shitagakiCheck();">下書きに戻す</button>
        <button class="action-sheet-button" onclick="deleteCheck();">ギフト削除</button>
        <button class="action-sheet-button" onclick="mygiftActionClose();">Cancel</button>
    </div>
    <div class="alert-dialog-mask gift_shitagaki_dialog_mask"></div>
    <div class="alert-dialog gift_shitagaki_dialog">
        <div class="alert-dialog-container">
            <div id="shitagakiTitle" class="alert-dialog-content">
                下書きに戻しますか？
            </div>
            <div class="alert-dialog-footer">
            <button class="alert-dialog-button" onclick="mygiftShitagaki();">Yes</button>
            <button class="alert-dialog-button alert-dialog-button--primal" onclick="shitagakiCheckClose();">No</button>
            </div>
        </div>
    </div>
    <div class="alert-dialog-mask shitagakiEnd_dialog_mask"></div>
    <div class="alert-dialog shitagakiEnd_dialog">
        <div class="alert-dialog-container">
            <div class="alert-dialog-title">変更完了</div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button alert-dialog-button--primal" onclick="shitagakiEndClose();">OK</button>
            </div>
        </div>
    </div>
    <div class="alert-dialog-mask shitagakiEndMiss_dialog_mask"></div>
    <div class="alert-dialog shitagakiEndMiss_dialog">
        <div class="alert-dialog-container">
            <div class="alert-dialog-title">変更失敗</div>
            <div class="alert-dialog-content">
                再度試すか、お問い合わせください。
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button alert-dialog-button--primal" onclick="shitagakiEndMissClose();">OK</button>
            </div>
        </div>
    </div>
    <div class="alert-dialog-mask gift_delete_dialog_mask"></div>
    <div class="alert-dialog gift_delete_dialog">
        <div class="alert-dialog-container">
            <div class="alert-dialog-content">
                本当に削除しますか？
            </div>
            <div class="alert-dialog-footer">
            <button class="alert-dialog-button" onclick="mygiftDelete();">Yes</button>
            <button class="alert-dialog-button alert-dialog-button--primal" onclick="deleteCheckClose();">No</button>
            </div>
        </div>
    </div>
    <div class="alert-dialog-mask deleteEnd_dialog_mask"></div>
    <div class="alert-dialog deleteEnd_dialog">
        <div class="alert-dialog-container">
            <div class="alert-dialog-title">削除完了</div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button alert-dialog-button--primal" onclick="deleteEndClose();">OK</button>
            </div>
        </div>
    </div>
    <div class="alert-dialog-mask deleteEndMiss_dialog_mask"></div>
    <div class="alert-dialog deleteEndMiss_dialog">
        <div class="alert-dialog-container">
            <div class="alert-dialog-title">削除失敗</div>
            <div class="alert-dialog-content">
                再度削除頂くか、お問い合わせください。
            </div>
            <div class="alert-dialog-footer">
                <button class="alert-dialog-button alert-dialog-button--primal" onclick="deleteEndMissClose();">OK</button>
            </div>
        </div>
    </div>
    <script>
        $('.mygift_mask,.mygift_modal,.mygift_option_mask,.mygift_option_modal,.gift_delete_dialog_mask,.gift_delete_dialog,.deleteEnd_dialog_mask,.deleteEnd_dialog,.deleteEndMiss_dialog_mask,.deleteEndMiss_dialog,.gift_shitagaki_dialog_mask,.gift_shitagaki_dialog,.shitagakiEnd_dialog_mask,.shitagakiEnd_dialog,.shitagakiEndMiss_dialog_mask,.shitagakiEndMiss_dialog').hide();
        function mygiftHoukoku(){
            document.getElementById('navi').bringPageTop('houkokuForm.html');
            setTimeout(function(){
                $('#houkokuform_gift_id').val($('#my_gift_id').val());
                $('#houkokuform_gift_name').val($('#gift_detail_title').html());
                $('#houkokuform_gift_username').val($('#gift_detail_username').html());
            }, 500);
        }
        
        
        function mygiftAction(){
            $('.mygift_option_mask,.mygift_option_modal').slideDown();
        }
        
        function mygiftActionClose(){
            $('.mygift_option_modal').slideUp();
            setTimeout(function(){
                $('.mygift_option_mask').slideUp();
            },500);
        }

        function deleteCheck(){
            $('.mygift_option_modal').slideUp();
            setTimeout(function(){
                $('.mygift_option_mask').slideUp();
                $('.gift_delete_dialog_mask,.gift_delete_dialog').slideDown();
            },500);
        }

        function deleteCheckClose(){
            $('.gift_delete_dialog').slideUp();
            setTimeout(function(){
                $('.gift_delete_dialog_mask').slideUp();
            },500);
        }

        function deleteEndOpen(){
            $('.deleteEnd_dialog_mask,.deleteEnd_dialog').slideDown();

        }

        function deleteEndClose(){
            $('.deleteEnd_dialog').slideUp();
            setTimeout(function(){
                $('.deleteEnd_dialog_mask').slideUp();
                window.location.href = 'home.html';
            },500);
        }
        function deleteEndMissOpen(){
            $('.deleteEndMiss_dialog_mask,.deleteEndMiss_dialog').slideDown();
        }

        function deleteEndMissClose(){
            $('.deleteEndMiss_dialog').slideUp();
            setTimeout(function(){
                $('.deleteEndMiss_dialog_mask').slideUp();
                window.location.href = 'home.html';
            },500);
        }
        function mygiftDelete(){
            deleteCheckClose();
            var giftUid = $('#my_gift_id').val();
            var giftData = ncmb.DataStore("giftData");
            // データストアへの削除

            giftData
            .equalTo("giftUid", giftUid)
            .fetch()
            .then(function(results){
                    // 保存後の処理
                    results.delete();

                    var GiftFavorite = ncmb.DataStore("GiftFavorite");
                    // データストアへの削除
                    GiftFavorite
                    .equalTo("giftUid", giftUid)
                    .fetch()
                    .then(function(results){
                        results.delete();
                    });

                    ncmb.File.delete(giftUid)
                    .then(function(){
                    // 削除後処理
                    });

                    deleteEndOpen();
            })
            .catch(function(err){
                    // エラー処理
                    deleteEndMissOpen();
            });
        }
        function shitagakiCheck(){
            $('.mygift_option_modal').slideUp();
            setTimeout(function(){
                $('.mygift_option_mask').slideUp();
                $('.gift_shitagaki_dialog_mask,.gift_shitagaki_dialog').slideDown();
            },500);
        }

        function shitagakiCheckClose(){
            $('.gift_shitagaki_dialog').slideUp();
            setTimeout(function(){
                $('.gift_shitagaki_dialog_mask').slideUp();
            },500);
        }

        function shitagakiEndOpen(){
            $('.shitagakiEnd_dialog_mask,.shitagakiEnd_dialog').slideDown();

        }

        function shitagakiEndClose(){
            $('.shitagakiEnd_dialog').slideUp();
            setTimeout(function(){
                $('.shitagakiEnd_dialog_mask').slideUp();
                window.location.href = 'home.html';
            },500);
        }
        function shitagakiEndMissOpen(){
            $('.shitagakiEndMiss_dialog_mask,.shitagakiEndMiss_dialog').slideDown();
        }

        function shitagakiEndMissClose(){
            $('.shitagakiEndMiss_dialog').slideUp();
            setTimeout(function(){
                $('.shitagakiEndMiss_dialog_mask').slideUp();
                window.location.href = 'home.html';
            },500);
        }
        function mygiftShitagaki(){
            shitagakiCheckClose();
            var ReleaseStatus = $('#ReleaseStatus').val();
            if(ReleaseStatus == 1){
                ReleaseStatus = 0;
            }else{
                ReleaseStatus = 1;
            }
            var giftUid = $('#my_gift_id').val();
            var giftData = ncmb.DataStore("giftData");
            // データストアへの削除

            giftData
            .equalTo("giftUid", giftUid)
            .fetch()
            .then(function(results){
                    // 保存後の処理
                    var object = results;
                    var objectId = object.get("userId");
                    var releaseDate = object.get("releaseDate");
                    var dt = new Date(releaseDate);
                    var m = ("00" + (dt.getMonth()+1)).slice(-2);
                    var d = ("00" + dt.getDate()).slice(-2);
                    var hh = dt.getHours();
                    if (hh < 10) {
                            hh = "0" + hh;
                    }
                    var mm = dt.getMinutes();
                    if (mm < 10) {
                            mm = "0" + mm;
                    }
                    var releaseDate = m + "月" + d + "日 " +hh + "時" + mm + "分";
                    var giftTitle = object.get("giftTitle");
                    var giftText = object.get("giftText");
                    var giftText = giftText.replace(/<br>/g,'');
                    var price = object.get("price");
                    if(ReleaseStatus!=1){
                        ons.notification.confirm({
                            message: '通知をONにしているファンの方に出品通知が飛びます。',
                            title: "確認",
                            buttonLabels:["キャンセル","OK"],
                            callback: function(buttonIndex) {
                                    if(buttonIndex==1){
                                        var giftUrl = 'https://fanfun2020.xsrv.jp/customUrlScheme.html?GIFTorUSERID='+giftUid+'&page=giftPage';
                                        var follow = ncmb.DataStore("follow");
                                        follow
                                        .equalTo("followerId",objectId)
                                        .fetchAll()
                                        .then(function(results){
                                                for(var j=0;j<results.length;j++){
                                                        var forUserId = results[j].get("followId");
                                                        if(results[j].get("bellmark")=="ON"){
                                                                followUserSyuppinMail(forUserId,releaseDate,giftTitle,giftText,price,giftUrl,objectId);
                                                                followUserSyuppinPushNotification(forUserId,objectId);
                                                        }
                                                }
                                        }).then(function(){
                                            results
                                            .set("ReleaseStatus",ReleaseStatus)
                                            .update();
                                            shitagakiEndOpen();
                                        }).catch(function(err){
                                            // エラー処理
                                            shitagakiEndMissOpen();
                                        });
                                    }
                            }
                        });
                    }else{
                        results.set("ReleaseStatus",ReleaseStatus)
                            .update();
                        shitagakiEndOpen();
                    }
                    
            })
            .catch(function(err){
                    // エラー処理
                    shitagakiEndMissOpen();
            });
        }

        var gift_image_detail = $('.gift_image_detail').width();
        $('.gift_image_detail').height(gift_image_detail);
        $('#gift_detail_image_zone').height($('#gift_detail_image_zone').width());
    </script>
    <style>
        .favorite_on{
            color:#FF6070;
        }
        .favorite_off{
            color:gray;
        }
    </style>
</ons-page>